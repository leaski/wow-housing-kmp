<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guild Housing Map</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="grid-overlay.css">
</head>
<body>
    <div class="map-container">
        <div class="map-background" id="mapBackground">
            <!-- House plots will be dynamically positioned here -->
        </div>
    </div>

    <div class="legend">
        <h3>Legend</h3>
        <div class="legend-item">
            <div class="legend-color available"></div>
            <span>Available</span>
        </div>
        <div class="legend-item">
            <div class="legend-color occupied"></div>
            <span>Occupied</span>
        </div>
        <div style="margin-top: 10px; font-size: 10px; color: #ccc;">
            Press <strong>G</strong> to toggle grid
        </div>
    </div>

    <script>
        let housingData = [];

        function getDigitsOnly(inputString) {
        // The regex pattern \D matches any character that is NOT a digit.
        // The 'g' flag ensures all occurrences are replaced (global search).
        return parseInt(inputString.replace(/\D/g, ''), 10);
        }


        const apiKey = 'AIzaSyDvg7T4yBMPicNUucxhxKBrZUTYAfIFqS8';       // Replace with your API Key
        const spreadsheetId = '1WWK7kqyoA_qjW3sYMo87S0Rp36ccifFPjBvuX2jQyVk'; // Replace with your Spreadsheet ID
        const range = 'Plot List!A1:D56';             // Replace with your sheet name and cell range (A1 notation)

        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;

        async function fetchGoogleSheetData() {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const rows = data.values;
                
                if (rows && rows.length) {
                // console.log('Data retrieved successfully:');

                const filteredRows = rows.filter((data) => {
                    const [plotName, availability, name] = data;
                    if (name) return data;
                })
                return filteredRows;
                // rows will be an array of arrays, e.g., [['Header1', 'Header2'], ['Value1', 'Value2'], ...]
                } else {
                // console.log('No data found in the specified range.');
                }
            } catch (error) {
                // console.error('Error fetching Google Sheets data:', error);
            }
        }

        
        async function getData(){
            const data = await fetchGoogleSheetData();

            const housingDataExample = {
                0: "Neviriah",
                6: "Elvor",
                7: "GasLightatdawn",
                8: "Koren",
                12: "Sailer",
                13: "Sensayy",
                17: "Baelys",
                21: "guest",
                22: "Briar",
                23: "Lionhart",
                24: "Halfyy",
                28: "Aex",
                29: "Gwen",
                31: "Diff",
                32: "Kafka",
                38: "Nobbel",
                41: "Phate",
                43: "Cirillie",
                46: "Wacsnie",
                50: "Sungli"
            };
            housingData = data.reduce((acc, row) => {
                const [plotName, availability, name] = row;
                console.log(name)
                const plotNameFiltered = getDigitsOnly(plotName);
                acc[plotNameFiltered] = name;
                return acc;
            }, {});
        }

        // Housing data from CSV
        // House plot positions loaded from external JSON file
        let plotPositions = [];
        let mapImageData = {};

        async function loadPlotPositions() {
            try {
                const response = await fetch('plot-positions.json');
                const data = await response.json();
                plotPositions = data.plotPositions;
                mapImageData = data.referenceImage;
                // console.log('Plot positions loaded successfully:', data);
            } catch (error) {
                console.error('Error loading plot positions:', error);
                // Fallback to empty array if JSON fails to load
                plotPositions = [];
            }
        }

        function createHousePlots() {
            const mapBackground = document.getElementById('mapBackground');
            
            // Clear existing plots
            mapBackground.innerHTML = '';
            
            plotPositions.forEach((position) => {
                const plot = document.createElement('div');
                plot.className = 'house-plot';
                plot.textContent = position.plotNumber;
                
                // Check if plot is occupied
                if (housingData[position.plotNumber]) {
                    plot.classList.add('occupied');
                    
                    // Add tooltip with buyer name
                    const tooltip = document.createElement('div');
                    tooltip.className = 'plot-info';
                    tooltip.textContent = `Plot ${position.plotNumber}: ${housingData[position.plotNumber]}`;
                    plot.appendChild(tooltip);
                } else {
                    // Add tooltip for available plot
                    const tooltip = document.createElement('div');
                    tooltip.className = 'plot-info';
                    tooltip.textContent = `Plot ${position.plotNumber}: Available`;
                    plot.appendChild(tooltip);
                }
                
                // Position the plot
                plot.style.left = position.x + 'px';
                plot.style.top = position.y + 'px';
                
                mapBackground.appendChild(plot);
            });
        }

        function updatePlotPositions() {
            const mapBackground = document.getElementById('mapBackground');
            const plots = document.querySelectorAll('.house-plot');
            
            if (plots.length === 0) return;
            
            // Get the actual map image dimensions and position (same logic as grid)
            const mapImage = new Image();
            mapImage.onload = function() {
                const mapRect = mapBackground.getBoundingClientRect();
                const containerWidth = mapRect.width;
                const containerHeight = mapRect.height;
                
                // Calculate the actual displayed image dimensions (maintaining aspect ratio)
                const imageAspectRatio = mapImage.width / mapImage.height;
                const containerAspectRatio = containerWidth / containerHeight;
                
                let imageWidth, imageHeight, offsetX, offsetY;
                
                if (imageAspectRatio > containerAspectRatio) {
                    // Image is wider than container
                    imageWidth = containerWidth;
                    imageHeight = containerWidth / imageAspectRatio;
                    offsetX = 0;
                    offsetY = (containerHeight - imageHeight) / 2;
                } else {
                    // Image is taller than container
                    imageHeight = containerHeight;
                    imageWidth = containerHeight * imageAspectRatio;
                    offsetX = (containerWidth - imageWidth) / 2;
                    offsetY = 0;
                }
                
                // Calculate scale factor from original image to displayed image
                const scaleX = imageWidth / mapImage.width;
                const scaleY = imageHeight / mapImage.height;
                
                // Update plot positions using the same logic as grid
                plots.forEach((plot, index) => {
                    const originalPos = plotPositions[index];
                    if (originalPos) {
                        const scaledX = offsetX + (originalPos.x * scaleX);
                        const scaledY = offsetY + (originalPos.y * scaleY);
                        
                        plot.style.left = scaledX + 'px';
                        plot.style.top = scaledY + 'px';
                    }
                });
            };
            
            mapImage.src = 'map.jpg';
        }

        // Initialize the map
        document.addEventListener('DOMContentLoaded', async function() {
            // Load plot positions from JSON file first
            await loadPlotPositions();
            
            await getData();
            // Create house plots after positions are loaded
            createHousePlots();
            
            // Update positions on window resize
            let plotResizeTimeout;
            window.addEventListener('resize', function() {
                // Clear existing timeout to prevent multiple rapid calls
                clearTimeout(plotResizeTimeout);
                // Update immediately for responsiveness
                updatePlotPositions();
            });
            
            // Initial position update
            setTimeout(updatePlotPositions, 100);
            
            // Create initial grid overlay
            //setTimeout(createGridOverlay, 500);
        });
    </script>
    <script src="grid-overlay.js"></script>
</body>
</html>
